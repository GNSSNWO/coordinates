from contextlib import contextmanager
from io import StringIO
from tempfile import NamedTemporaryFile

import pytest
from os import remove

_nav_content_v2 = '''\
     2              NAVIGATION DATA                         RINEX VERSION / TYPE
CCRINEXN V1.6.0 UX  CDDIS               12-APR-16 17:31     PGM / RUN BY / DATE 
IGS BROADCAST EPHEMERIS FILE                                COMMENT             
    0.1583D-07  0.1490D-07 -0.1192D-06 -0.1192D-06          ION ALPHA           
    0.1065D+06  0.6554D+05 -0.1966D+06 -0.1966D+06          ION BETA            
    0.186264514923D-08 0.000000000000D+00   233472     1892 DELTA-UTC: A0,A1,T,W
    17                                                      LEAP SECONDS        
                                                            END OF HEADER       
 1 16  4 11  0  0  0.0 0.169607810676D-04 0.113686837722D-11 0.000000000000D+00
    0.350000000000D+02 0.222500000000D+02 0.482198656938D-08 0.368417754673D+00
    0.121630728245D-05 0.527631223667D-02 0.668689608574D-05 0.515364252472D+04
    0.864000000000D+05 0.391155481338D-07-0.140616900879D+01 0.106170773506D-06
    0.963711739811D+00 0.247687500000D+03 0.450110393247D+00-0.827070165078D-08
    0.284654714154D-09 0.100000000000D+01 0.189200000000D+04 0.000000000000D+00
    0.200000000000D+01 0.000000000000D+00 0.512227416039D-08 0.350000000000D+02
    0.805020000000D+05 0.400000000000D+01 0.000000000000D+00 0.000000000000D+00
 2 16  4 11  0  0  0.0 0.597649253905D-03-0.181898940355D-11 0.000000000000D+00
    0.830000000000D+02 0.185937500000D+02 0.527057686384D-08 0.763017673126D+00
    0.114180147648D-05 0.156129685929D-01 0.783614814282D-05 0.515374914742D+04
    0.864000000000D+05-0.163912773132D-06-0.145069785349D+01 0.100582838059D-06
    0.942463959213D+00 0.223656250000D+03-0.213318032835D+01-0.861071569602D-08
    0.216080431326D-09 0.100000000000D+01 0.189200000000D+04 0.000000000000D+00
    0.200000000000D+01 0.000000000000D+00-0.200234353542D-07 0.830000000000D+02
    0.864000000000D+05 0.000000000000D+00 0.000000000000D+00 0.000000000000D+00
'''

_nav_content_v3 = '''\
     3.03           NAVIGATION DATA     M (Mixed)           RINEX VERSION / TYPE
BCEmerge            congo               20170909 012902 GMT PGM / RUN BY / DATE 
Merged GPS/GLO/GAL/BDS/QZS/SBAS/IRNSS navigation file       COMMENT 
based on CONGO and MGEX tracking data                       COMMENT 
DLR: O. Montenbruck;  TUM: P. Steigenberger                 COMMENT 
GAUT  2.7939677238e-09 1.776356839e-15 345600 1965          TIME SYSTEM CORR    
GLGP  1.8626451492e-08 0.000000000e+00 345600 1965          TIME SYSTEM CORR    
GLUT  9.3132257462e-10 0.000000000e+00 345600 1965          TIME SYSTEM CORR    
GPGA  1.0040821508e-08 3.330669074e-14 432000 1965          TIME SYSTEM CORR    
GPUT  9.3132257462e-10 1.776356839e-15 589824 1965          TIME SYSTEM CORR    
QZUT  6.5192580223e-09 0.000000000e+00   8192 1966          TIME SYSTEM CORR    
    18                                                      LEAP SECONDS        
                                                            END OF HEADER       
G01 2017 09 08 00 00 00 5.530333146453e-05-4.547473508865e-13 0.000000000000e+00
     7.200000000000e+01-2.653125000000e+01 4.883774857397e-09-2.309091328065e-01
    -1.233071088791e-06 7.021094555967e-03 2.788379788399e-06 5.153673307419e+03
     4.320000000000e+05 7.823109626770e-08 2.011192878165e+00 4.284083843231e-08
     9.681868691207e-01 3.310000000000e+02 6.192489497701e-01-8.576071513516e-09
    -2.500104139373e-11 1.000000000000e+00 1.965000000000e+03 0.000000000000e+00
     2.000000000000e+00 0.000000000000e+00 5.587935447693e-09 7.200000000000e+01
     4.248180000000e+05 4.000000000000e+00                                      
S20 2017 09 08 00 16 32 0.000000000000e+00 0.000000000000e+00 4.330030000000e+05
     4.063672000000e+04 0.000000000000e+00 0.000000000000e+00 1.000000000000e+00
    -1.124591600000e+04 0.000000000000e+00 0.000000000000e+00 3.276700000000e+04
     0.000000000000e+00 0.000000000000e+00 0.000000000000e+00 2.150000000000e+02
'''

_nav_content_v3_unsorted = '''\
     3.03           NAVIGATION DATA     M (Mixed)           RINEX VERSION / TYPE
BCEmerge            congo               20170909 012902 GMT PGM / RUN BY / DATE 
    18                                                      LEAP SECONDS        
                                                            END OF HEADER       
S20 2017 09 08 00 05 52 0.000000000000e+00 0.000000000000e+00 4.323620000000e+05
     4.063672000000e+04 0.000000000000e+00 0.000000000000e+00 1.000000000000e+00
    -1.124591600000e+04 0.000000000000e+00 0.000000000000e+00 3.276700000000e+04
     0.000000000000e+00 0.000000000000e+00 0.000000000000e+00 2.200000000000e+01
S20 2017 09 08 00 00 32 0.000000000000e+00 0.000000000000e+00 4.320410000000e+05
     4.063672000000e+04 0.000000000000e+00 0.000000000000e+00 1.000000000000e+00
    -1.124591600000e+04 0.000000000000e+00 0.000000000000e+00 3.276700000000e+04
     0.000000000000e+00 0.000000000000e+00 0.000000000000e+00 2.000000000000e+00
S20 2017 09 08 00 03 12 0.000000000000e+00 0.000000000000e+00 4.322000000000e+05
     4.063672000000e+04 0.000000000000e+00 0.000000000000e+00 1.000000000000e+00
    -1.124591600000e+04 0.000000000000e+00 0.000000000000e+00 3.276700000000e+04
     0.000000000000e+00 0.000000000000e+00 0.000000000000e+00 1.200000000000e+01
'''

@contextmanager
def mktmp(tmp_str):
    tmp_file_name = None

    try:
        with NamedTemporaryFile(mode='w', delete=False) as tmp_file:
            tmp_file.writelines(tmp_str)
            tmp_file_name = tmp_file.name

        yield tmp_file_name

    finally:
        if tmp_file_name:
            remove(tmp_file_name)


@pytest.fixture
def nav_file_v2():
    return mktmp(_nav_content_v2)


@pytest.fixture
def nav_iter_v2():
    return StringIO(_nav_content_v2)


@pytest.fixture
def nav_file_v3():
    return mktmp(_nav_content_v3)


@pytest.fixture
def nav_iter_v3():
    return StringIO(_nav_content_v3)


@pytest.fixture
def nav_file_unsorted_v3():
    return mktmp(_nav_content_v3_unsorted)
